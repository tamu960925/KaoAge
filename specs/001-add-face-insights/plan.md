# Implementation Plan: Face Insights SDK

**Branch**: `[001-add-face-insights]` | **Date**: 2025-11-02 | **Spec**: [Feature Spec](spec.md)
**Input**: Feature specification from `/specs/001-add-face-insights/spec.md`

**Note**: Generated by `/speckit.plan`. Use CLI help for the detailed workflow.

## Summary

Deliver an Android 10+ on-device SDK that exposes face bounding boxes, landmarks, Euler angles, BestShot markers, and age/gender estimates through Kotlin-first, Java-friendly parcelable models serialized via `toJson()`, while keeping camera control and image ownership within the host app using Kotlin 1.9.24, ML Kit Face Detection, and on-device age/gender models orchestrated through configurable detection sessions.

## Technical Context

**Language/Version**: Kotlin 1.9.24 with Android Gradle Plugin 8.6.0 targeting Android API 29+  
**Primary Dependencies**: ML Kit Face Detection on-device API; kotlinx-serialization JSON for `toJson()`; AndroidX lifecycle & coroutines for frame pipeline coordination  
**ML Outputs**: Landmark coordinates (eyes, nose, mouth), bounding boxes, Euler yaw/pitch/roll, age bracket + confidence, gender cue + confidence, BestShot signal metadata  
**Storage**: None — results remain in memory; confirm no caching layers added  
**Testing**: Strict TDD per t-wada: write failing Robolectric/JUnit tests before production code; expect parameterized specs for face detection edge cases  
**Target Platform**: Android 10+ host app integrating `sdk-core` (analysis) and `sdk-bestshot` (quality scoring) plus `samples/cashier-app` for verification  
**Project Type**: Gradle multi-module Android library + sample app + docs + scripts  
**Performance Goals**: Meet SC-001 (≤500 ms detection for 95% frames) and maintain ≤30% sustained CPU on Pixel 6 (Tensor G1) and Pixel 4a (Snapdragon 730G) reference devices  
**Constraints**: On-device processing only; host owns camera; SDK models parcelable with `toJson()`; camera frames provided as `ImageProxy`/`ByteBuffer` without SDK storing pixels  
**Scale/Scope**: Public API surface includes detection session configuration, result callbacks, BestShot notifier; sample app demonstrates cashier verification and privacy assurances

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- ✅ Kotlin-only source modules with Java interop annotations (`@JvmStatic`, `@JvmOverloads`, builders)
- ✅ ML Kit Face Detection selected for all face analytics; no alternative detectors or cloud services
- ✅ Age/gender inference uses approved on-device models (via `scripts/download_models.sh`) with documented calibration metrics
- ✅ Camera session remains in the host app; plan will detail frame handoff and BestShot response contract
- ✅ SDK outputs parcelable models with `toJson()`, face box, Euler angles, and required landmarks
- ✅ External models sourced via `scripts/download_models.sh`, loaded through File/ByteBuffer/AFD paths
- ✅ Test plan lists failing Robolectric/JUnit specs authored first, aligning with t-wada TDD guidance
- ✅ New dependencies include documented license review and test coverage strategy
- ✅ No image persistence or off-device processing introduced; privacy obligations reiterated for host app

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)
<!--
  ACTION REQUIRED: Replace the placeholder tree below with the concrete layout
  for this feature. Delete unused options and expand the chosen structure with
  real paths (e.g., apps/admin, packages/something). The delivered plan must
  not include Option labels.
-->

```text
sdk-core/
├── src/main/kotlin/        # Face frame adapters, ML Kit integration, age/gender inference orchestration
├── src/test/kotlin/        # Failing TDD specs around detectors, converters, error states
└── build.gradle.kts

sdk-bestshot/
├── src/main/kotlin/        # BestShot scoring heuristics and confidence aggregation
├── src/test/kotlin/
└── build.gradle.kts

samples/cashier-app/
├── src/main/kotlin/        # Host camera lifecycle, UI overlays, privacy messaging
├── src/main/res/
└── build.gradle.kts

docs/
├── compliance/
├── sdk/
└── privacy/

scripts/
└── download_models.sh      # Managed entry point for external model assets
```

**Structure Decision**: `sdk-core` delivers ML orchestration and result models, `sdk-bestshot` encapsulates frame quality logic for reuse across hosts, `samples/cashier-app` demonstrates integration and compliance prompts, and `docs/` captures model calibration plus privacy commitments.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |

## Constitution Check (Post-Design Review)

- ✅ Kotlin-first modules with Java interop remain the only planned source artifacts.
- ✅ ML Kit Face Detection and sanctioned on-device age/gender models stay authoritative; no cloud fallbacks introduced.
- ✅ Host app retains camera lifecycle; SDK contract only consumes frame metadata and returns analysis objects.
- ✅ Parcelable result models provide bounding boxes, Euler angles, landmarks, and JSON serialization.
- ✅ Scripts/download_models.sh remains the sole ingestion point for external ML assets.
- ✅ TDD workflow mandates failing Robolectric/JUnit specs ahead of implementation and documents coverage expansion.
- ✅ Plan forbids image persistence or network transmission, reinforcing on-device privacy guarantees.
